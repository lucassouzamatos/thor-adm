#!/bin/sh
set -e

unset authority_keys

just_print=false

usage() {
  _usage "$1" <<EOF
Usage: $(basename $0) [-djh] TORRC
EOF
}

while [[ "$1" = -* ]]; do
  case "$1" in
    -d|--dry-run)
	    dryrun=true
	    ;;
    -j|--just-print)
	    just_print=true
	    ;;
    -o|--output)
        output=$2
        shift
        ;;
    -a|--authority-keys)
	    authority_keys=$2
	    shift
	    ;;
    -h|--help)
	    usage
	    ;;
    *)
     	    usage "Unknow argument: $1" 
	    ;;
  esac
  shift
done

torrc=$1

if [ -z "${torrc}" ]; then
  usage "Missing torrc argument."
fi

get_config() {
  grep "^$1" ${torrc} | awk -F " " '{print $2}'
}

#################################################################
# Gather configuration values directly from torrc file.
#################################################################

datadir="$(get_config DataDirectory)"
nick="$(get_config Nickname)"
address="$(get_config Address)"
dirport="$(get_config DirPort)"
orport="$(get_config ORPort)"

# strip trailing backslash
datadir="${datadir%/}"

long_line
info Gathered information:
info DataDirectory: ${datadir}
info Nickname: ${nick}
info DirPort: ${dirport}
info Address: ${address}
info ORPort: ${orport}
long_line

# stop early when it needs just to print
$just_print && exit 0

#################################################################
# Create node certificates.
#################################################################

# make sure data directory structure exists
run_it mkdir -p "${datadir}/keys"

# go to keys directory
run_it cd "${datadir}/keys"

# generate certificates 
echo "gns3" | run_it tor-gencert \
  --create-identity-key \
  -a ${address}:${dirport} \
  --passphrase-fd 0

# generate tor keys and list fingerprint 
fp_cmd="tor --list-fingerprint -f ${torrc} --orport 1 --dirserver 'x 127.0.0.1:1 ffffffffffffffff"
info "Calling: ${fp_cmd}"
if ! $dryrun; then
 tor -f ${torrc} \
    --list-fingerprint \
    --orport 1 \
    --dirserver 'x 127.0.0.1:1 ffffffffffffffffffffffffffffffffffffffff' \
    --datadirectory ${datadir} 
fi

# go back to old directory
run_it cd -

#################################################################
# Get fingerprints to add on torrc.
#################################################################

# retrieve node fingerprints
cert_fp=$(run_it grep "fingerprint" ${datadir}/keys/*)
node_fp=$(run_it cat ${datadir}/fingerprint)

dir_opt="DirAuthority ${nick} orport=${orport} no-v2 v3ident=${cert_fp##* } ${address}:${dirport}"

auth_line="\n# GENERATED BY $(basename $0) AT $(date +%d-%m-%yT%H:%M:%S)\n${dir_opt}"

long_line
info ${dir_opt}
info Appending DirAuthority to torrc
info ${auth_line} | run_it tee -a ${authority_keys:-${torrc}}
long_line